import DocsLayout from '../../../layouts/DocsLayout';
import { Image } from 'theme-ui';

<DocsLayout>


# Smart Contract API Reference

## Overview

1. **Matching Engine:** This API is used by most users, as it is the API for accessing the sorted order book and matching engine. The order book is implemented as a double-linked sorted list and at any one time the list should return sorted.

2. **Average Price Fill-Or-Kill Orders:** This API is dedicated to **Takers** and works by executing a special type of order called "Average Price fill-or-kill order". This order type is using the order book to calculate an average price with a threshold based on the amount the user wants to sell or buy. This order will never stay on the order book and if it cannot be matched (due to exceeding the gas block limit or by reaching the threshold), the transaction will revert. For example, the discontinued frontend [oasis.direct](https://oasis.direct) used this, and it is now what **[Oasis Instant](http://oasis.app/instant)** uses.

3. **Administrative Methods:** This includes all of the administrative functions used to set the market parameters.

# Key Functionalities within each group

## 1. Matching Market:

- **getBestOffer( ERC20 pay_gem, ERC20 buy_gem )** - gets an offer from the top of the order book. Use with combination with `getWorseOffer()/getBetterOffer()`
	- **ERC20 pay_gem** - address of a ERC20 token contract
	- **ERC20 buy_gem** - address of a ERC20 token contract
	- Returns **(uint offerId)** - the id of the best offer for **pay_gem:buy_gem** pair.

	**_Example:_**

	```
	export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
	export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
	export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c  

	$ seth --to-dec $(seth call $OTC_MARKET 'getBestOffer(address,address)' $WETH $DAI)
	118172
	```

 	**_Note:_** Given the following market `WETH/DAI` if `WETH`'s address is passed as a `pay_gem` then the id of the best `ask` will be returned. If `DAI`'s address is passed as a `pay_gem` then the id of the best `bid` will be returned


- **getWorseOffer( unint id )**  - used to navigate throughout the orderbook.
	- **uint id** - Id of the starting offer
	- Returns **( uint offerId)** - Id of a worse offer. If current offer is a `ask` one then a worse offer will have higher price and if current offer is a `bid` one then a worse offer will have lower price

	**_Example:_**

	```
	export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
	export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
	export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

	$ BEST_OFFER_ID=$(seth --to-dec $(seth call $OTC_MARKET 'getBestOffer(address,address)' $WETH $DAI))

	$ seth --to-dec $(seth call $OTC_MARKET 'getWorseOffer(uint)' $BEST_OFFER_ID)
	13
	```

- **getBetterOffer( uint id )**
	- **uint id** - Id of the starting offer
	- Returns **( uint offerId )** - Id of a better offer. If current offer is a `ask` one, a better offer will have lower price and if current offer is a `bid` one a better offer will have higher price

	**_Example:_**

	```
	export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
	export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
	export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

	$ seth --to-dec $(seth call $OTC_MARKET 'getBetterOffer(uint)' 13)
	118172

	``` 

- **getOfferCount( ERC20 pay_gem, ERC20 buy_gem )** - used to get the size of the orderbook
	- **ERC20 pay_gem** - address of a ERC20 token contract
	- **ERC20 buy_gem** - address of a ERC20 token contract
	- Returns **( uint size )** - the size either of all `asks` or all `bids`.
	
	**_Example:_** 

	```
	$ seth --to-dec $(seth call $OTC_MARKET 'getOfferCount(address,address)' $WETH $DAI)
	14

	$ seth --to-dec $(seth call $OTC_MARKET 'getOfferCount(address,address)' $DAI $WETH)
	1
	```

	**_Note:_** Give the following market `WETH/DAI` if `WETH`'s address is passed as a `pay_gem` then the size of the `asks` is returned. If `DAI`'s address is passed as a `pay_gem` then the size of the `bids` is returned


- **getOffer( uint id )** - use to retrieve offer information for specific offer id.

   - **uint id** - id of the offer

   - Returns **(uint, ERC20, uint, ERC20)** - tuple with `(pay_amt pay_gem buy_amt buy_gem)`. It contains the token addresses and the respective amounts
	
	**_Example:_**

	```
	export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
	export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
	export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

	$ seth call $OTC_MARKET 'getOffer(uint)(uint256,address,uint256,address)' 118172
	16345785d8a0000
	d0a1e359811322d97991e03f863a0c30c2cf029c
	ebec21ee1da40000
	4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa

	$ seth --from-wei $(seth --to-dec 16345785d8a0000)
	0.100000000000000000

	$ seth --from-wei $(seth --to-dec ebec21ee1da40000)
	17.000000000000000000

	```

   **_Note:_** It's important to understand that there is no price value stored in the offer's data. Price is determined by dividing token amounts. If the offer is an `ask` one then the price is calculated `buy_amt/pay_amt` and if the offer is `bid` then the price is `pay_amt/buy_amt`

- **buy(id, amount)** - the buy function is used to fill a specific order (“cherrypicks”). By calling this function, it will execute and settle a trade all within one atomic transaction. **Note:** Can be called externally by the user, and is also called internally by the matching engine (see **offer()** method for more details).
   - `uint id` - offer id
   - `uint amount` - amount
   - Returns: `bool success`  

- **take(id, amount)** - provides the byte32 version of **buy().**
   - `bytes32 id` - offer id
   - `uint amount` - amount
   - Returns: `bool success` 

- **cancel(id)** - cancels an order with a given order ID.
   - `uint id` - offer id
   - Returns: `bool success`  

- **kill(id)** - provides the byte32 version of cancel(). 
   - `uint id` - offer id
   - Returns: `bool success`

- **offer(pay_amt, pay_gem, buy_amt, buy_gem, pos)** - Create an order. If possible, will match existing orders. **Note:** the main API of the matching engine. This method should be used 99% of the time!
   - `uint pay_amt` - sell amount of `pay_gem`
   - `ERC20 pay_gem` - token that maker (ask) sells
   - `uint buy_amt` - buy amount of `buy_gem`
   - `ERC20 buy_gem` - token that maker (ask) buys
   - `uint pos` - the estimated position to insert an offer
   - Returns: `uint offerId`  

- **offer(pay_amt, pay_gem, buy_amt, buy_gem, pos, rounding)** - allows for overwriting the rounding parameter which is set to `true` as a default.

**Note: regarding the Position (pos) parameter:** If you pass `pos=0` this means that the contract will have to find where to insert the order. In the case of a very large order book, it will take a significantly larger amount of gas to insert the new order (may even result in an out of gas error and cause the TX to fail) compared to inserting an order with known a (calculated in advance ) pos. Inserting a known pos is done manually. You must look at the current offers list and see which entry point position corresponds for your new order. This provides a reference point for the contract to know where to begin looking. After this, the contract will make adjustments it if was an incorrect pos or if it was changed during the time between the transaction being sent and mined. The closer you are from the real position, the less amount of gas the contract will spend.
 
## 2. Average Price Fill-Or-Kill Orders:
  
- **sellAllAmount(pay_gem, pay_amt, buy_gem, min_fill_amount) -** is used when triggering an ERC20 for ERC20 exchange, where the payAmt is sent to the matching market from the caller. This function attempts to spend all of the pay tokens to buy a specified minimum amount of buy tokens. It is possible for more tokens to be bought if it is possible (depends on token price volatility and specified payAmt).

- **buyAllAmount(buy_gem, buy_amt, pay_gem, max_fill_amount) -** is used when triggering an ERC20 token for ERC20 token exchange. This function works by attempting to buy a specified amount of buy tokens for a specified amount of pay tokens (up to a certain price). It will calculate the amount to be paid, then that amount is transferred to this matching market. This function is used when there is an amount to buy and it gets the best offer for the described token pair.

- **getBuyAmount(buy_gem, pay_gem, pay_amt) -** This function is used to get the `buy` amount and will return how much of the collateral token can be bought by paying the specified`pay_amt`. Its purpose is to retrieve the best offer for the token pair.

- **getPayAmount(pay_gem, buy_gem, buy_amt) -** This function is used to get the `pay` amount and will return how much of the collateral token is needed in order to buy the specified `buy_amt`. This also tries to retrieve the best offer for the token pair.

## 3. Administrative Methods

- **stop()** - stops the market.

- **setMatchingEnabled()** - stops matching engine.

- **setMinSell()/getMinSell()** - sets/gets the dust limit for a token.

</DocsLayout>
