import DocsLayout from '../../../layouts/DocsLayout';
import { Image } from 'theme-ui';

<DocsLayout>


# Smart Contract API Reference

## Overview

1. **Matching Engine:** This API is used by most users, as it is the API for accessing the sorted order book and matching engine.

2. **Average Price Fill-Or-Kill Orders:** This API is dedicated to **Takers** and works by executing a special type of order called "Average Price fill-or-kill order". This order type is using the order book to calculate an average price with a threshold based on the amount the user wants to sell or buy. This order will never stay on the order book and if it cannot be matched (due to exceeding the gas block limit or by reaching the threshold), the transaction will revert. For example, the discontinued frontend [oasis.direct](https://oasis.direct) used this, and it is now what **[Oasis Instant](http://oasis.app/instant)** uses.

3. **Administrative Methods:** This includes all of the administrative functions used to set the market parameters.

# Key Functionalities within each group

## **Matching Market**

### **Orderbook Navigation**

Those methods give the ability to navigate throughout the order book.
The order book is implemented as a double-linked sorted list and at any time the list should be sorted.
It has two sides. One of  the sides contains all buy offers which are called `bids` and the other side contains 
all of the sell orders which are called `asks`

#### **Get Best Offer** 

Used to get the best offer for a given token pair. 

Given the following market _WETH/DAI_ if _WETH_'s address is passed as a _pay_gem_ then the id of the best _ask_ will be returned
If _DAI_'s address is passed as a _pay_gem_ then the id of the best `bid` will be returned.
This method is used in combination with _getWorseOffer / getBetterOffer_.

```
function getBestOffer(ERC20 pay_gem, ERC20 buy_gem) public view returns(uint)
```

- **pay_gem**: An address of an ERC20 token contract
- **buy_gem**: An address of an ERC20 token contract 
- **RETURN**: Id(number) of the best offer for **pay_gem:buy_gem** pair.

**Seth:**
  
```
export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c  

$ seth --to-dec $(seth call $OTC_MARKET 'getBestOffer(address,address)' $WETH $DAI)
118172
```

**Ethers JS (v5):**

```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const otcContract = new ethers.Contract(OTC_MARKET, OTC_ABI, provider);
const bestOfferId = await otcContract.getBestOffer(WETH, DAI)

console.log(bestOfferId.toString()) // 118172
```

#### **Get Worse Offer**

Used to get the next worse offer in the sorted linked list. If the offer which _id_ is used in the method call ( current offer ) is an `ask` one then a worse offer will have higher price.
If the current offer is a `bid` one then a worse offer will have lower price

```
function getWorseOffer(uint id) public view returns(uint)
```

- **id**: Id of an offer compareted to which a worse offer will be returned
- **RETURN**: Id(number) of a worse offer

**Seth:**

```
export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

$ BEST_OFFER_ID=$(seth --to-dec $(seth call $OTC_MARKET 'getBestOffer(address,address)' $WETH $DAI))

$ seth --to-dec $(seth call $OTC_MARKET 'getWorseOffer(uint)' $BEST_OFFER_ID)
13
```

**Ethers JS (v5)**
```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const otcContract = new ethers.Contract(OTC_MARKET, OTC_ABI, provider);
const bestOfferId = await otcContract.getBestOffer(WETH, DAI)
const worseOfferId = await otcContract.getWorseOffer(bestOfferId)
console.log(worseOfferId.toString()) // 13
```


#### **Get Better Offer**

Used to get the next better offer in the sorted linked list. If the offer which _id_ is used in the method call ( current offer ) is an `ask` one then a better offer will have lower price.
If the current offer is a `bid` one then a better offer will have higher price

```
function getBetterOffer(uint id) public view returns(uint)
```

- **id**: Id of an offer compareted to which a worse offer will be returned
- **RETURN**: Id(number) of a better offer

**Seth:**

```
export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

$ seth --to-dec $(seth call $OTC_MARKET 'getBetterOffer(uint)' 13)
118172

``` 

**Javascript:**
```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const otcContract = new ethers.Contract(OTC_MARKET, OTC_ABI, provider);

const currentOfferId = 13
const betterOfferId = await otcContract.getBetterOffer(currentOfferId)
console.log(betterOfferId.toString())
```

#### Get Offer Count

Used to get the amount of offers for a given side of the order book.
Give the following market _WETH/DAI_ if _WETH_'s address is passed as a _pay_gem_ then the size of the _asks_ is returned. If _DAI_'s address is passed as a _pay_gem_ then the size of the _bids_ is returned.

```
function getOfferCount(ERC20 pay_gem, ERC20 buy_gem) public view returns(uint)
```

- **pay_gem**: An address of an ERC20 token contract
- **buy_gem**: An address of an ERC20 token contract 
- **RETURN**: Size(number) either of all `asks` or all `bids`.

**Seth:**

```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const otcContract = new ethers.Contract(OTC_MARKET, OTC_ABI, provider);

export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

// Size of asks
$ seth --to-dec $(seth call $OTC_MARKET 'getOfferCount(address,address)' $WETH $DAI)
14 

// size of bids
$ seth --to-dec $(seth call $OTC_MARKET 'getOfferCount(address,address)' $DAI $WETH)
1
```

***Ethers JS (v5)**
```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const asksSize = await otcContract.getOfferCount(WETH, DAI)
const bidsSize = await otcContract.getOfferCount(DAI, WETH)
console.log(`Asks Size: ${asksSize.toString()}`, `Bid Size: ${bidsSize.toString()}`) // Ask Size: 14, Bids Size: 1
```

#### Get Offer

Used to retrieve offer details for a specific offer id.
It's important to understand that there is no price value stored in the offer's data.
Price is determined by dividing token amounts.
If the offer is an _ask_ one then the price is calculated _buy_amt/pay_amt_ and if the offer is _bid_ then the price is _pay_amt/buy_amt_


```
function getOffer(uint id) public view returns (uint, ERC20, uint, ERC20)
```

- **id**: An id of the offer
- **RETURN**: Tuple of four values _(pay_amt pay_gem buy_amt buy_gem)_.

   _pay_amt_ - amount that sells

   _pay_gem_ - token that sells

   _buy_amt_ - amount that buys
   
   _buy_gem_ - token that buys

**Seth:**
```
export OTC_MARKET=0xe325acb9765b02b8b418199bf9650972299235f4
export DAI=0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa
export WETH=0xd0a1e359811322d97991e03f863a0c30c2cf029c

$ seth call $OTC_MARKET 'getOffer(uint)(uint256,address,uint256,address)' 118172
16345785d8a0000
d0a1e359811322d97991e03f863a0c30c2cf029c // 0xd0a1e359811322d97991e03f863a0c30c2cf029c - WETH address
ebec21ee1da40000
4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa // 0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa - DAI address

$ seth --from-wei $(seth --to-dec 16345785d8a0000)
0.100000000000000000

$ seth --from-wei $(seth --to-dec ebec21ee1da40000)
17.000000000000000000
```

**Ethers JS (v5)**
```
const OTC_ABI = //otc contract abi defined

const OTC_MARKET='0xe325acb9765b02b8b418199bf9650972299235f4'
const DAI='0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa'
const WETH='0xd0a1e359811322d97991e03f863a0c30c2cf029c'

const bestOfferId = await otcContract.getBestOffer(WETH, DAI)
const [pay_amt, pay_gem, buy_amt, buy_gem ] = await otcContract.getOffer(bestOfferId)

console.log(pay_gem) //  0xd0a1e359811322d97991e03f863a0c30c2cf029c - WETH address
console.log(ethers.utils.formatEther(pay_amt)) // 0.1
console.log(buy_gem) // 0x4f96fe3b7a6cf9725f59d353f723c1bdb64ca6aa - DAI address
console.log(ethers.utils.formatEther(buy_amt)) // 17.00

const price = buy_amt.div(pay_amt)
console.log(price.toString())
```
   
- **buy(id, amount)** - the buy function is used to fill a specific order (“cherrypicks”). By calling this function, it will execute and settle a trade all within one atomic transaction. **Note:** Can be called externally by the user, and is also called internally by the matching engine (see **offer()** method for more details).
   - `uint id` - offer id
   - `uint amount` - amount
   - Returns: `bool success`  

- **take(id, amount)** - provides the byte32 version of **buy().**
   - `bytes32 id` - offer id
   - `uint amount` - amount
   - Returns: `bool success` 

- **cancel(id)** - cancels an order with a given order ID.
   - `uint id` - offer id
   - Returns: `bool success`  

- **kill(id)** - provides the byte32 version of cancel(). 
   - `uint id` - offer id
   - Returns: `bool success`

- **offer(pay_amt, pay_gem, buy_amt, buy_gem, pos)** - Create an order. If possible, will match existing orders. **Note:** the main API of the matching engine. This method should be used 99% of the time!
   - `uint pay_amt` - sell amount of `pay_gem`
   - `ERC20 pay_gem` - token that maker (ask) sells
   - `uint buy_amt` - buy amount of `buy_gem`
   - `ERC20 buy_gem` - token that maker (ask) buys
   - `uint pos` - the estimated position to insert an offer
   - Returns: `uint offerId`  

- **offer(pay_amt, pay_gem, buy_amt, buy_gem, pos, rounding)** - allows for overwriting the rounding parameter which is set to `true` as a default.

**Note: regarding the Position (pos) parameter:** If you pass `pos=0` this means that the contract will have to find where to insert the order. In the case of a very large order book, it will take a significantly larger amount of gas to insert the new order (may even result in an out of gas error and cause the TX to fail) compared to inserting an order with known a (calculated in advance ) pos. Inserting a known pos is done manually. You must look at the current offers list and see which entry point position corresponds for your new order. This provides a reference point for the contract to know where to begin looking. After this, the contract will make adjustments it if was an incorrect pos or if it was changed during the time between the transaction being sent and mined. The closer you are from the real position, the less amount of gas the contract will spend.
 
## 2. Average Price Fill-Or-Kill Orders:
  
- **sellAllAmount(pay_gem, pay_amt, buy_gem, min_fill_amount) -** is used when triggering an ERC20 for ERC20 exchange, where the payAmt is sent to the matching market from the caller. This function attempts to spend all of the pay tokens to buy a specified minimum amount of buy tokens. It is possible for more tokens to be bought if it is possible (depends on token price volatility and specified payAmt).

- **buyAllAmount(buy_gem, buy_amt, pay_gem, max_fill_amount) -** is used when triggering an ERC20 token for ERC20 token exchange. This function works by attempting to buy a specified amount of buy tokens for a specified amount of pay tokens (up to a certain price). It will calculate the amount to be paid, then that amount is transferred to this matching market. This function is used when there is an amount to buy and it gets the best offer for the described token pair.

- **getBuyAmount(buy_gem, pay_gem, pay_amt) -** This function is used to get the `buy` amount and will return how much of the collateral token can be bought by paying the specified`pay_amt`. Its purpose is to retrieve the best offer for the token pair.

- **getPayAmount(pay_gem, buy_gem, buy_amt) -** This function is used to get the `pay` amount and will return how much of the collateral token is needed in order to buy the specified `buy_amt`. This also tries to retrieve the best offer for the token pair.

## 3. Administrative Methods

- **stop()** - stops the market.

- **setMatchingEnabled()** - stops matching engine.

- **setMinSell()/getMinSell()** - sets/gets the dust limit for a token.

</DocsLayout>
